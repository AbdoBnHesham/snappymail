/* RainLoop Webmail (c) RainLoop Team | MIT */
(()=>{"use strict";var e=20,t=jQuery;const n=e=>void 0!==e;var o={contains:(e,t)=>!(!e||!t)&&(e===t||(e.contains?e.contains(t):!!t.compareDocumentPosition&&!!(8&t.compareDocumentPosition(e)))),mainClearTimeout:e=>{0<e&&clearTimeout(e),e=0},getEvent:e=>(e=e&&(e.originalEvent?e.originalEvent:e)||window.event).dataTransfer?e:null,getValue:(e,t,o)=>e&&t&&n(e[t])?e[t]:o,scopeBind:(e,t)=>(...o)=>e.apply(n(t)?t:null,Array.prototype.slice.call(o)),fakeMd5:e=>{var t="",o="0123456789abcdefghijklmnopqrstuvwxyz";for(e=n(e)?parseInt(e||0,10):32;t.length<e;)t+=o.substr(Math.round(Math.random()*o.length),1);return t},getNewUid:()=>"jua-uid-"+o.fakeMd5(16)+"-"+(new Date).getTime().toString(),getDataFromFile:e=>{var t=n(e.fileName)?e.fileName:n(e.name)?e.name:null,o=n(e.fileSize)?e.fileSize:n(e.size)?e.size:null,i=n(e.type)?e.type:null;return"/"===t.charAt(0)&&(t=t.substr(1)),i||0!==o?{FileName:t,Size:o,Type:i,Folder:"",File:e}:null},getDataFromFiles:(t,i,r,a)=>{var l,u,s=0,p=0,c=null,d=null,g=!1;if(l=r=n(r)?parseInt(r||0,10):e,u=0<r,t=t&&0<t.length?t:null)for(p=0,s=t.length;p<s;p++)(c=t[p])&&(!u||0<=--r?(d=o.getDataFromFile(c))&&i(d):u&&!g&&0>r&&a&&(g=!0,a(l)))},getDataFromInput:(e,t,n,i)=>{var r=e&&e.files&&0<e.files.length?e.files:null;r?o.getDataFromFiles(r,t,n,i):t({FileName:e.value.split("\\").pop().split("/").pop(),Size:null,Type:null,Folder:"",File:null})},eventContainsFiles:e=>{var t=!1;if(e&&e.dataTransfer&&e.dataTransfer.types&&e.dataTransfer.types.length)for(var n=0,o=e.dataTransfer.types.length;n<o;n++)if("files"===e.dataTransfer.types[n].toLowerCase()){t=!0;break}return t},getDataFromDragEvent:(e,t,n,i)=>{var r=null;(e=o.getEvent(e))&&o.eventContainsFiles(e)&&(r=o.getValue(e,"files",null)||(e.dataTransfer?o.getValue(e.dataTransfer,"files",null):null))&&0<r.length&&o.getDataFromFiles(r,t,n,i)},createNextLabel:()=>t('<label style="position: absolute; background-color:#fff; right: 0px; top: 0px; left: 0px; bottom: 0px; margin: 0px; padding: 0px; cursor: pointer;"></label>').css({opacity:0}),createNextInput:()=>t('<input type="file" tabindex="-1" hidefocus="hidefocus" style="position: absolute; left: -9999px;" />'),getNewInput:(e,t)=>{e=n(e)?e.toString():"";var i=o.createNextInput();return 0<e.length&&i.attr("name",e),n(t)&&!t||i.prop("multiple",!0),i},getStringOrCallFunction:(e,n)=>t.isFunction(e)?e.apply(null,Array.isArray(n)?n:[]).toString():e.toString()};function i(e,t){this.oXhrs={},this.oUids={},this.oJua=e,this.oOptions=t}function r(t){t=n(t)?t:{};var r=this,a=jQuery;r.bEnableDnD=!0,r.oEvents={onDialog:null,onSelect:null,onStart:null,onComplete:null,onCompleteAll:null,onProgress:null,onDragEnter:null,onDragLeave:null,onDrop:null,onBodyDragEnter:null,onBodyDragLeave:null,onLimitReached:null},r.oOptions={action:"",name:"",hidden:{},queueSize:10,clickElement:!1,dragAndDropElement:!1,dragAndDropBodyElement:!1,disableDragAndDrop:!1,disableMultiple:!1,disableDocumentDropPrevent:!1,multipleSizeLimit:50},Object.entries(t).forEach(([e,t])=>r.oOptions[e]=t),r.oQueue=function(e){function t(){if(n&&r<e){var i=n,l=i[0],c=Array.prototype.slice.call(i,1),d=i.index;n=n===o?o=null:n.next,++r,c.push(function(e,i){--r,u||(e?a&&p(u=e,a=s=n=o=null):(s[d]=i,--a?t():p(null,s)))}),l.apply(null,c)}}var n,o,i={},r=0,a=0,l=-1,u=null,s=[],p=()=>{};return arguments.length<1&&(e=1/0),i.defer=function(){if(!u){var e=arguments;e.index=++l,o?(o.next=e,o=o.next):n=o=e,++a,t()}return i},i.await=function(e){return p=e,a||p(u,s),i},i}(parseInt(o.getValue(r.oOptions,"queueSize",10)||0,10)),r.runEvent("onCompleteAll")&&r.oQueue.await(function(){r.runEvent("onCompleteAll")}),r.oDriver=new i(r,r.oOptions),r.oClickElement=o.getValue(r.oOptions,"clickElement",null),r.oClickElement&&(a(r.oClickElement).css({position:"relative",overflow:"hidden"}),"inline"===a(this.oClickElement).css("display")&&a(this.oClickElement).css("display","inline-block"),this.oDriver.generateNewInput(this.oClickElement)),this.oDriver.isDragAndDropSupported()&&o.getValue(this.oOptions,"dragAndDropElement",!1)?function(t){var n=a(document),i=a(o.getValue(t.oOptions,"dragAndDropBodyElement",!1)||n),r=o.getValue(t.oOptions,"dragAndDropElement",!1);r&&(o.getValue(t.oOptions,"disableDocumentDropPrevent",!1)||n.on("dragover",function(e){if(t.bEnableDnD&&e&&(e=o.getEvent(e))&&e.dataTransfer&&o.eventContainsFiles(e))try{e.dataTransfer.dropEffect="none",e.preventDefault()}catch(e){}}),i&&i[0]&&i.on("dragover",function(e){t.bEnableDnD&&e&&o.mainClearTimeout(t.iDocTimer)}).on("dragenter",function(e){t.bEnableDnD&&e&&(e=o.getEvent(e))&&o.eventContainsFiles(e)&&(o.mainClearTimeout(t.iDocTimer),e.preventDefault(),t.runEvent("onBodyDragEnter",[e]))}).on("dragleave",function(e){t.bEnableDnD&&e&&(e=o.getEvent(e))&&(o.mainClearTimeout(t.iDocTimer),t.iDocTimer=setTimeout(function(){t.runEvent("onBodyDragLeave",[e])},200))}).on("drop",function(e){if(t.bEnableDnD&&e&&(e=o.getEvent(e))){var n=o.eventContainsFiles(e);return n&&e.preventDefault(),t.runEvent("onBodyDragLeave",[e]),!n}return!1}),a(r).on("dragenter",function(e){t.bEnableDnD&&e&&(e=o.getEvent(e))&&o.eventContainsFiles(e)&&(o.mainClearTimeout(t.iDocTimer),e.preventDefault(),t.runEvent("onDragEnter",[r,e]))}).on("dragover",function(e){if(t.bEnableDnD&&e&&(e=o.getEvent(e))&&e.dataTransfer&&o.eventContainsFiles(e))try{var n=e.dataTransfer.effectAllowed;o.mainClearTimeout(t.iDocTimer),e.dataTransfer.dropEffect="move"===n||"linkMove"===n?"move":"copy",e.stopPropagation(),e.preventDefault(),i.trigger("dragover",e)}catch(e){}}).on("dragleave",function(e){if(t.bEnableDnD&&e&&(e=o.getEvent(e))){var n=document.elementFromPoint?document.elementFromPoint(e.clientX,e.clientY):null;if(n&&o.contains(this,n))return;o.mainClearTimeout(t.iDocTimer),t.runEvent("onDragLeave",[r,e])}}).on("drop",function(n){t.bEnableDnD&&n&&(n=o.getEvent(n))&&o.eventContainsFiles(n)&&(n.preventDefault(),o.getDataFromDragEvent(n,function(e){e&&(t.runEvent("onDrop",[e,n]),t.addNewFile(e),o.mainClearTimeout(t.iDocTimer))},o.getValue(t.oOptions,"multipleSizeLimit",e),t.getEvent("onLimitReached"))),t.runEvent("onDragLeave",[n])}))}(r):r.bEnableDnD=!1}i.prototype.oXhrs={},i.prototype.oUids={},i.prototype.oJua=null,i.prototype.oOptions={},i.prototype.isDragAndDropSupported=(()=>!0),i.prototype.regTaskUid=function(e){this.oUids[e]=!0},i.prototype.uploadTask=function(e,i,r){if(!1===this.oUids[e]||!i||!i.File)return r(null,e),!1;try{var a=this,l=new XMLHttpRequest,u=new FormData,s=o.getValue(this.oOptions,"action",""),p=o.getValue(this.oOptions,"hidden",{}),c=this.oJua.getEvent("onStart"),d=this.oJua.getEvent("onComplete"),g=this.oJua.getEvent("onProgress");return l.open("POST",s,!0),g&&l.upload&&(l.upload.onprogress=function(t){t&&t.lengthComputable&&n(t.loaded)&&n(t.total)&&g(e,t.loaded,t.total)}),l.onreadystatechange=function(){if(4===l.readyState&&200===l.status){if(d){var t=!1,o=null;try{o=JSON.parse(l.responseText),t=!0}catch(e){o=null}d(e,t,o)}n(a.oXhrs[e])&&(a.oXhrs[e]=null),r(null,e)}else 4===l.readyState&&(d(e,!1,null),r(null,e))},c&&c(e),u.append("jua-post-type","ajax"),u.append(o.getValue(this.oOptions,"name","juaFile"),i.File),t.each(p,function(e,t){u.append(e,o.getStringOrCallFunction(t,[i]))}),l.send(u),this.oXhrs[e]=l,!0}catch(e){}return r(null,e),!1},i.prototype.generateNewInput=function(n){var i=this,r=null,a=null;n&&(a=o.getNewInput("",!o.getValue(this.oOptions,"disableMultiple",!1)),(r=o.createNextLabel()).append(a),t(n).append(r),a.on("click",function(){var e=i.oJua.getEvent("onDialog");e&&e()}).on("change",function(){o.getDataFromInput(this,function(e){i.oJua.addNewFile(e),i.generateNewInput(n),setTimeout(function(){r.remove()},10)},o.getValue(i.oOptions,"multipleSizeLimit",e),i.oJua.getEvent("onLimitReached"))}))},i.prototype.cancel=function(e){if(this.oUids[e]=!1,this.oXhrs[e]){try{this.oXhrs[e].abort&&this.oXhrs[e].abort()}catch(e){}this.oXhrs[e]=null}},r.prototype.bEnableDnD=!0,r.prototype.iDocTimer=0,r.prototype.oOptions={},r.prototype.oEvents={},r.prototype.oQueue=null,r.prototype.oDriver=null,r.prototype.on=function(e,t){return this.oEvents[e]=t,this},r.prototype.runEvent=function(e,t){this.oEvents[e]&&this.oEvents[e].apply(null,t||[])},r.prototype.getEvent=function(e){return this.oEvents[e]||null},r.prototype.cancel=function(e){this.oDriver.cancel(e)},r.prototype.setDragAndDropEnabledStatus=function(e){this.bEnableDnD=!!e},r.prototype.isDragAndDropSupported=function(){return this.oDriver.isDragAndDropSupported()},r.prototype.addNewFile=function(e){this.addFile(o.getNewUid(),e)},r.prototype.addFile=function(e,t){var n=this.getEvent("onSelect");!t||n&&!1===n(e,t)?this.oDriver.cancel(e):(this.oDriver.regTaskUid(e),this.oQueue.defer(o.scopeBind(this.oDriver.uploadTask,this.oDriver),e,t))},window.Jua=r})();
