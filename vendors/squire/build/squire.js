(e=>{"use strict";const t=3,n=9,o=e.defaultView,i=navigator.userAgent,r=/Mac OS X/.test(i),s=/Windows NT/.test(i),a=/iP(?:ad|hone|od)/.test(i)||r&&!!navigator.maxTouchPoints,l=/Gecko\//.test(i),d=/Edge\//.test(i),c=!d&&/WebKit\//.test(i),h=r?"meta-":"ctrl-",f=r?"metaKey":"ctrlKey",u=/[^ \t\r\n]/,p=(e,t)=>Array.prototype.indexOf.call(e,t),g={1:1,2:2,3:4,8:128,9:256,11:1024},m=/^(?:#text|A|ABBR|ACRONYM|B|BR|BDI|BDO|CITE|CODE|DATA|DEL|DFN|EM|FONT|HR|IMG|INPUT|INS|KBD|Q|RP|RT|RUBY|SAMP|SMALL|SPAN|STRIKE|STRONG|SUB|SUP|TIME|U|VAR|WBR)$/,S={BR:1,HR:1,IMG:1},N=e=>1===e.nodeType&&!!S[e.nodeName],_=e=>{switch(e.nodeType){case t:return 1;case 1:case 11:if(ie.has(e))return ie.get(e);break;default:return 0}let n;return n=Array.prototype.every.call(e.childNodes,C)?m.test(e.nodeName)?1:2:3,ie.set(e,n),n},C=e=>1===_(e),v=e=>2===_(e),T=e=>3===_(e),y=(t,n)=>{let o=e.createTreeWalker(n,1,v);return o.currentNode=t,o},E=(e,t)=>(e=y(e,t).previousNode())!==t?e:null,L=(e,t)=>(e=y(e,t).nextNode())!==t?e:null,b=e=>!e.textContent&&!e.querySelector("IMG"),k=(e,t)=>!N(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText),O=(e,t,n)=>{if(e.nodeName!==t)return!1;for(let t in n)if(e.getAttribute(t)!==n[t])return!1;return!0},x=(e,t,n)=>(e=(e=!e||e.closest?e:e.parentElement)&&e.closest(n))&&t.contains(e)?e:null,A=(e,t,n,o)=>{for(;e&&e!==t;){if(O(e,n,o))return e;e=e.parentNode}return null},R=(e,t,n)=>{let o,i,r,s,a,l="";return e&&e!==t&&(l=R(e.parentNode,t,n),1===e.nodeType&&(l+=(l?">":"")+e.nodeName,(o=e.id)&&(l+="#"+o),(i=e.className.trim())&&((r=i.split(/\s+/)).sort(),l+=".",l+=r.join(".")),(s=e.dir)&&(l+="[dir="+s+"]"),r&&(a=n.classNames,p(r,a.highlight)>-1&&(l+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),p(r,a.colour)>-1&&(l+="[color="+e.style.color.replace(/ /g,"")+"]"),p(r,a.fontFamily)>-1&&(l+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),p(r,a.fontSize)>-1&&(l+="[fontSize="+e.style.fontSize+"]")))),l},B=e=>{let t=e.nodeType;return 1===t||11===t?e.childNodes.length:e.length||0},D=t=>{let n=e.createDocumentFragment(),o=t.childNodes;return o&&n.append(...o),n},U=(e,t,n,o)=>{let i,r,s=e.createElement(t);if(n instanceof Array&&(o=n,n=null),n)for(i in n)void 0!==(r=n[i])&&s.setAttribute(i,r);return o&&s.append(...o),s},P=(n,o)=>{let i,r,s=o.__squire__,a=n;if(n===o&&((r=n.firstChild)&&"BR"!==r.nodeName||(i=s.createDefaultBlock(),r?r.replaceWith(i):n.append(i),n=i,i=null)),n.nodeType===t)return a;if(C(n)){for(r=n.firstChild;c&&r&&r.nodeType===t&&!r.data;)n.removeChild(r),r=n.firstChild;r||(c?(i=e.createTextNode("​"),s._didAddZWS()):i=e.createTextNode(""))}else if(!n.querySelector("BR"))for(i=U(e,"BR");(r=n.lastElementChild)&&!C(r);)n=r;if(i)try{n.append(i)}catch(e){s.didError({name:"Squire: fixCursor – "+e,message:"Parent: "+n.nodeName+"/"+n.innerHTML+" appendChild: "+i.nodeName})}return a},I=(t,n)=>{let o,i,r,s,a=t.childNodes,l=null;for(o=0,i=a.length;o<i;++o)!(s="BR"===(r=a[o]).nodeName)&&C(r)?(l||(l=U(e,"div")),l.append(r),--o,--i):(s||l)&&(l||(l=U(e,"div")),P(l,n),s?r.replaceWith(l):(r.before(l),++o,++i),l=null),T(r)&&I(r,n);return l&&t.append(P(l,n)),t},F=(e,n,o,i)=>{let r,s,a,l=e.nodeType;if(l===t&&e!==o)return F(e.parentNode,e.splitText(n),o,i);if(1===l){if("number"==typeof n&&(n=n<e.childNodes.length?e.childNodes[n]:null),e===o)return n;for(r=e.parentNode,s=e.cloneNode(!1);n;)a=n.nextSibling,s.append(n),n=a;return"OL"===e.nodeName&&x(e,i,"BLOCKQUOTE")&&(s.start=(+e.start||1)+e.childNodes.length-1),P(e,i),P(s,i),e.after(s),F(r,s,o,i)}return n},W=(e,n)=>{let o,i,r=e.childNodes,s=r.length,a=[];for(;s--;)o=r[s],i=s&&r[s-1],s&&C(o)&&k(o,i)&&!S[o.nodeName]?(n.startContainer===o&&(n.startContainer=i,n.startOffset+=B(i)),n.endContainer===o&&(n.endContainer=i,n.endOffset+=B(i)),n.startContainer===e&&(n.startOffset>s?--n.startOffset:n.startOffset===s&&(n.startContainer=i,n.startOffset=B(i))),n.endContainer===e&&(n.endOffset>s?--n.endOffset:n.endOffset===s&&(n.endContainer=i,n.endOffset=B(i))),o.remove(),o.nodeType===t?i.appendData(o.data):a.push(D(o))):1===o.nodeType&&(o.append(...a.reverse()),a=[],W(o,n))},M=(e,n)=>{if(e.nodeType===t&&(e=e.parentNode),1===e.nodeType){let t={startContainer:n.startContainer,startOffset:n.startOffset,endContainer:n.endContainer,endOffset:n.endOffset};W(e,t),n.setStart(t.startContainer,t.startOffset),n.setEnd(t.endContainer,t.endOffset)}},w=(e,t,n,o)=>{let i,r,s,a=t;for(;(i=a.parentNode)&&i!==o&&1===i.nodeType&&1===i.childNodes.length;)a=i;a.remove(),s=e.childNodes.length,(r=e.lastChild)&&"BR"===r.nodeName&&(e.removeChild(r),--s),e.append(D(t)),n.setStart(e,s),n.collapse(!0),M(e,n)},H=(t,n)=>{let o,i,r=t.previousSibling,s=t.firstChild,a="LI"===t.nodeName;if(!a||s&&/^[OU]L$/.test(s.nodeName))if(r&&k(r,t)){if(!T(r)){if(!a)return;(i=U(e,"DIV")).append(D(r)),r.append(i)}t.remove(),o=!T(t),r.append(D(t)),o&&I(r,n),s&&H(s,n)}else a&&(r=U(e,"DIV"),s.before(r),P(r,n))},z=(e,t)=>{let n=e.childNodes;for(;t&&1===e.nodeType;)t=(n=(e=n[t-1]).childNodes).length;return e},q=(e,t)=>{if(1===e.nodeType){let n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},K=(e,n)=>{let o,i,r,s,a=e.startContainer,l=e.startOffset,d=e.endContainer,c=e.endOffset;a.nodeType===t?(i=(o=a.parentNode).childNodes,l===a.length?(l=p(i,a)+1,e.collapsed&&(d=o,c=l)):(l&&(s=a.splitText(l),d===a?(c-=l,d=s):d===o&&++c,a=s),l=p(i,a)),a=o):i=a.childNodes,l===(r=i.length)?a.append(n):i[l].before(n),a===d&&(c+=i.length-r),e.setStart(a,l),e.setEnd(d,c)},G=(n,o,i)=>{let r=n.startContainer,s=n.startOffset,a=n.endContainer,l=n.endOffset;o||(o=n.commonAncestorContainer),o.nodeType===t&&(o=o.parentNode);let d,c,h,f,u,g=F(a,l,o,i),m=F(r,s,o,i),S=e.createDocumentFragment();for(;m!==g;)d=m.nextSibling,S.append(m),m=d;return r=o,s=g?p(o.childNodes,g):o.childNodes.length,(c=(h=o.childNodes[s])&&h.previousSibling)&&c.nodeType===t&&h.nodeType===t&&(r=c,s=c.length,f=c.data,u=h.data," "===f.charAt(f.length-1)&&" "===u.charAt(0)&&(u=" "+u.slice(1)),c.appendData(u),h.remove()),n.setStart(r,s),n.collapse(!0),P(o,i),S},Q=(e,t)=>{let n,o,i=Y(e,t),r=X(e,t),s=i!==r;return $(e),V(e,i,r,t),n=G(e,null,t),$(e),s&&(r=X(e,t),i&&r&&i!==r&&w(i,r,e,t)),i&&P(i,t),(o=t.firstChild)&&"BR"!==o.nodeName?e.collapse(!0):(P(t,t),e.selectNodeContents(t.firstChild)),n},Z=(t,n,o)=>{let i=e.createRange();if(i.selectNode(n),o){let e=t.compareBoundaryPoints(3,i)>-1,n=t.compareBoundaryPoints(1,i)<1;return!e&&!n}{let e=t.compareBoundaryPoints(0,i)<1,n=t.compareBoundaryPoints(2,i)>-1;return e&&n}},$=e=>{let n,o=e.startContainer,i=e.startOffset,r=e.endContainer,s=e.endOffset,a=!0;for(;o.nodeType!==t&&(n=o.childNodes[i])&&!N(n);)o=n,i=0;if(s)for(;r.nodeType!==t;){if(!(n=r.childNodes[s-1])||N(n)){if(a&&n&&"BR"===n.nodeName){--s,a=!1;continue}break}s=B(r=n)}else for(;r.nodeType!==t&&(n=r.firstChild)&&!N(n);)r=n;e.collapsed?(e.setStart(r,s),e.setEnd(o,i)):(e.setStart(o,i),e.setEnd(r,s))},V=(e,n,o,i)=>{let r,s=e.startContainer,a=e.startOffset,l=e.endContainer,d=e.endOffset,c=!0;for(n||(n=e.commonAncestorContainer),o||(o=n);!a&&s!==n&&s!==i;)r=s.parentNode,a=p(r.childNodes,s),s=r;for(;l!==o&&l!==i&&(c&&l.nodeType!==t&&l.childNodes[d]&&"BR"===l.childNodes[d].nodeName&&(++d,c=!1),d===B(l));)r=l.parentNode,d=p(r.childNodes,l)+1,l=r;e.setStart(s,a),e.setEnd(l,d)},j=(e,t,n)=>{let o=x(e.endContainer,n,"A");if(o){let t=e.cloneRange();o=o.parentNode,V(t,o,o,n),t.endContainer===o&&(e.setStart(t.endContainer,t.endOffset),e.setEnd(t.endContainer,t.endOffset))}return e},Y=(e,t)=>{let n,o=e.startContainer;return C(o)?n=E(o,t):o!==t&&v(o)?n=o:(n=z(o,e.startOffset),n=L(n,t)),n&&Z(e,n,!0)?n:null},X=(e,t)=>{let n,o,i=e.endContainer;if(C(i))n=E(i,t);else if(i!==t&&v(i))n=i;else{if(!(n=q(i,e.endOffset))||!t.contains(n))for(n=t;o=n.lastChild;)n=o;n=E(n,t)}return n&&Z(e,n,!0)?n:null},J=n=>e.createTreeWalker(n,5,e=>e.nodeType===t?u.test(e.data):"IMG"===e.nodeName),ee=(e,n)=>{let o,i=e.startContainer,r=e.startOffset;if(i.nodeType===t){if(r)return!1;o=i}else if((o=q(i,r))&&!n.contains(o)&&(o=null),!o&&(o=z(i,r)).nodeType===t&&o.length)return!1;return(oe=J(Y(e,n))).currentNode=o,!oe.previousNode()},te=(e,n)=>{let o,i=e.endContainer,r=e.endOffset;if(oe=J(Y(e,n)),i.nodeType===t){if((o=i.data.length)&&r<o)return!1;oe.currentNode=i}else oe.currentNode=z(i,r);return!oe.nextNode()},ne=(e,t)=>{let n,o=Y(e,t),i=X(e,t);o&&i&&(n=o.parentNode,e.setStart(n,p(n.childNodes,o)),n=i.parentNode,e.setEnd(n,p(n.childNodes,i)+1))};let oe,ie=new WeakMap;TreeWalker.prototype.previousPONode=function(){let e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;for(;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(g[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};let re=function(e){if(e.defaultPrevented)return;let t=e.key.toLowerCase(),n="",o=this.getSelection();"backspace"!==t&&"delete"!==t&&(e.altKey&&(n+="alt-"),e[f]&&(n+=h),e.shiftKey&&(n+="shift-")),s&&e.shiftKey&&"delete"===t&&(n+="shift-"),t=n+t,this._keyHandlers[t]?this._keyHandlers[t](this,e,o):o.collapsed||e.isComposing||e[f]||1!==t.length||(this.saveUndoState(o),Q(o,this._root),this._ensureBottomLine(),this.setSelection(o),this._updatePath(o,!0))},se=e=>(t,n)=>{n.preventDefault(),t[e]()},ae=(e,t)=>(t=t||null,(n,o)=>{o.preventDefault();let i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}),le=(e,n)=>{try{n||(n=e.getSelection());let o,i=n.startContainer;for(i.nodeType===t&&(i=i.parentNode),o=i;C(o)&&(!o.textContent||"​"===o.textContent);)o=(i=o).parentNode;i!==o&&(n.setStart(o,p(o.childNodes,i)),n.collapse(!0),o.removeChild(i),v(o)||(o=E(o,e._root)),P(o,e._root),$(n)),i===e._root&&(i=i.firstChild)&&"BR"===i.nodeName&&i.remove(),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)}catch(t){e.didError(t)}},de=(e,t)=>{let n;for(;(n=e.parentNode)&&n!==t&&!n.isContentEditable;)e=n;e.remove()},ce=(n,o,i)=>{let r,s,a,l,d,c=n._root;if(n._recordUndoState(i),n._config.addLinks&&Ke(i.startContainer,c,n),n._removeZWS(),n._getRangeAndRemoveBookmark(i),i.collapsed||Q(i,c),(r=Y(i,c))&&(s=x(r,c,"PRE")))return $(i),a=i.startContainer,l=i.startOffset,a.nodeType!==t&&(a=e.createTextNode(""),s.insertBefore(a,s.firstChild)),o||"\n"!==a.data.charAt(l-1)&&!ee(i,c)||"\n"!==a.data.charAt(l)&&!te(i,c)?(a.insertData(l,"\n"),P(s,c),a.length===l+1?i.setStartAfter(a):i.setStart(a,l+1)):(a.deleteData(l&&l-1,l?2:1),(a=(d=F(a,l&&l-1,c,c)).previousSibling).textContent||a.remove(),a=n.createDefaultBlock(),d.before(a),d.textContent||d.remove(),i.setStart(a,0)),i.collapse(!0),n.setSelection(i),n._updatePath(i,!0),void n._docWasChanged();if(!r||o||/^T[HD]$/.test(r.nodeName))return j(i,0,c),K(i,n.createElement("BR")),i.collapse(!1),n.setSelection(i),void n._updatePath(i,!0);if(r=x(r,c,"LI")||r,b(r)&&(s=x(r,c,"UL,OL,BLOCKQUOTE")))return"BLOCKQUOTE"===s.nodeName?n.modifyBlocks(()=>n.createDefaultBlock(We(n)),i):n.decreaseListLevel(i);for(d=we(n,r,i.startContainer,i.startOffset),Fe(r),Te(r),P(r,c);1===d.nodeType;){let n,o=d.firstChild;if("A"===d.nodeName&&(!d.textContent||"​"===d.textContent)){o=e.createTextNode(""),d.replaceWith(o),d=o;break}for(;o&&o.nodeType===t&&!o.data&&(n=o.nextSibling)&&"BR"!==n.nodeName;)o.remove(),o=n;if(!o||"BR"===o.nodeName||o.nodeType===t)break;d=o}i=n.createRange(d,0),n.setSelection(i),n._updatePath(i,!0)},he={enter:a?(e,t,n)=>{e._saveRangeToBookmark(n);let o=e._getHTML(),i=()=>{e.removeEventListener("keyup",i),e._setHTML(o),n=e._getRangeAndRemoveBookmark(),ce(e,!1,n)};e.addEventListener("keyup",i)}:(e,t,n)=>{t.preventDefault(),ce(e,t.shiftKey,n)},"shift-enter":(e,t,n)=>e._keyHandlers.enter(e,t,n),backspace:(e,t,n)=>{let o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(ee(n,o)){t.preventDefault();let i,r=Y(n,o);if(!r)return;if(I(r.parentNode,o),i=E(r,o)){if(!i.isContentEditable)return void de(i,o);for(w(i,r,n,o),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&H(r,o),e.setSelection(n)}else if(r){let t=x(r,o,"UL,OL,BLOCKQUOTE");if(t)return"BLOCKQUOTE"===t.nodeName?e.modifyBlocks(He,n):e.decreaseListLevel(n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(()=>le(e),0);else t.preventDefault(),Q(n,o),le(e,n)},delete:(e,t,n)=>{let o,i,r,s,a,l,d=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(te(n,d)){if(t.preventDefault(),!(o=Y(n,d)))return;if(I(o.parentNode,d),i=L(o,d)){if(!i.isContentEditable)return void de(i,d);for(w(o,i,n,d),i=o.parentNode;i!==d&&!i.nextSibling;)i=i.parentNode;i!==d&&(i=i.nextSibling)&&H(i,d),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),V(n,d,d,d),s=n.endContainer,a=n.endOffset,1===s.nodeType&&(l=s.childNodes[a])&&"IMG"===l.nodeName)return t.preventDefault(),l.remove(),$(n),void le(e,n);e.setSelection(r),setTimeout(()=>le(e),0)}else t.preventDefault(),Q(n,d),le(e,n)},tab:(e,t,n)=>{let o,i,r=e._root;if(e._removeZWS(),n.collapsed&&ee(n,r))for(o=Y(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.increaseListLevel(n);break}o=i}},"shift-tab":(e,t,n)=>{let o,i=e._root;e._removeZWS(),n.collapsed&&ee(n,i)&&(o=n.startContainer,x(o,i,"UL,OL")&&(t.preventDefault(),e.decreaseListLevel(n)))},space:(e,t,n)=>{let o,i=e._root;if(e._recordUndoState(n),e._config.addLinks&&Ke(n.startContainer,i,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,n.collapsed&&n.endOffset===B(o))do{if("A"===o.nodeName){n.setStartAfter(o);break}}while(!o.nextSibling&&(o=o.parentNode)&&o!==i);n.collapsed||(Q(n,i),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},arrowleft:e=>e._removeZWS(),arrowright:e=>e._removeZWS()};function fe(e,t){let n=e._root,o=e.createRange(n,t?0:n.childNodes.length);return $(o),e.setSelection(o),e}r||(he.pageup=(e=>fe(e,!0)),he.pagedown=(e=>fe(e,!1)));const ue=e=>(t,n)=>{n.preventDefault(),t.changeIndentationLevel(e)},pe=(e,t)=>(n,o)=>{o.preventDefault();let i=n.getSelectionClosest("UL,OL");i&&e==i.nodeName?n.removeList():n[t]()};he[h+"b"]=ae("B"),he[h+"i"]=ae("I"),he[h+"u"]=ae("U"),he[h+"shift-7"]=ae("S"),he[h+"shift-5"]=ae("SUB",{tag:"SUP"}),he[h+"shift-6"]=ae("SUP",{tag:"SUB"}),he[h+"shift-8"]=pe("UL","makeUnorderedList"),he[h+"shift-9"]=pe("OL","makeOrderedList"),he[h+"["]=ue("decrease"),he[h+"]"]=ue("increase"),he[h+"d"]=se("toggleCode"),he[h+"y"]=se("redo"),he[h+"z"]=se("undo"),he[h+"shift-z"]=se("redo");let ge={1:10,2:13,3:16,4:18,5:24,6:32,7:48},me={fontWeight:{regexp:/^bold|^700/i,replace:e=>U(e,"B")},fontStyle:{regexp:/^italic/i,replace:e=>U(e,"I")},fontFamily:{regexp:u,replace:(e,t,n)=>U(e,"SPAN",{class:t.fontFamily,style:"font-family:"+n})},fontSize:{regexp:u,replace:(e,t,n)=>U(e,"SPAN",{class:t.fontSize,style:"font-size:"+n})},textDecoration:{regexp:/^underline/i,replace:e=>U(e,"U")}},Se=t=>n=>{let o=U(e,t);return Array.prototype.forEach.call(n.attributes,e=>o.setAttribute(e.name,e.value)),n.replaceWith(o),o.append(D(n)),o},Ne={SPAN:(t,n,o)=>{let i,r,s,a,l,d,c=t.style;for(i in me)if(r=me[i],(s=c[i])&&r.regexp.test(s)){if((d=r.replace(e,o.classNames,s)).nodeName===t.nodeName&&d.className===t.className)continue;l||(l=d),a&&a.append(d),a=d,t.style[i]=""}return l&&(a.append(D(t)),t.append(l)),a||t},STRONG:Se("B"),EM:Se("I"),INS:Se("U"),STRIKE:Se("S"),FONT:(t,n,o)=>{let i,r,s,a,l,d=t.face,c=t.size,h=t.color,f=o.classNames;return d&&(l=i=U(e,"SPAN",{class:f.fontFamily,style:"font-family:"+d}),a=i),c&&(r=U(e,"SPAN",{class:f.fontSize,style:"font-size:"+ge[c]+"px"}),l||(l=r),a&&a.append(r),a=r),h&&/^#?([\dA-F]{3}){1,2}$/i.test(h)&&("#"!==h.charAt(0)&&(h="#"+h),s=U(e,"SPAN",{class:f.colour,style:"color:"+h}),l||(l=s),a&&a.append(s),a=s),l||(l=a=U(e,"SPAN")),t.replaceWith(l),a.append(D(t)),a},TT:(t,n,o)=>{let i=U(e,"SPAN",{class:o.classNames.fontFamily,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceWith(i),i.append(D(t)),i}},_e=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Ce=/^(?:HEAD|META|STYLE)/,ve=(n,o,i)=>{let r,s,a,l,d,c,h,f,p,g,m,S,N=n.childNodes;for(r=n;C(r);)r=r.parentNode;let _=e.createTreeWalker(r,5);for(s=0,a=N.length;s<a;++s)if(d=(l=N[s]).nodeName,c=l.nodeType,h=Ne[d],1===c){if(f=l.childNodes.length,h)l=h(l,n,o);else{if(Ce.test(d)){n.removeChild(l),--s,--a;continue}if(!_e.test(d)&&!C(l)){--s,a+=f-1,l.replaceWith(D(l));continue}}f&&ve(l,o,i||"PRE"===d)}else{if(c===t){if(m=l.data,p=!u.test(m.charAt(0)),g=!u.test(m.charAt(m.length-1)),i||!p&&!g)continue;if(p){for(_.currentNode=l;(S=_.previousPONode())&&!("IMG"===(d=S.nodeName)||"#text"===d&&u.test(S.data));)if(!C(S)){S=null;break}m=m.replace(/^[ \t\r\n]+/g,S?" ":"")}if(g){for(_.currentNode=l;(S=_.nextNode())&&!("IMG"===d||"#text"===d&&u.test(S.data));)if(!C(S)){S=null;break}m=m.replace(/[ \t\r\n]+$/g,S?" ":"")}if(m){l.data=m;continue}}n.removeChild(l),--s,--a}return n},Te=e=>{let n,o=e.childNodes,i=o.length;for(;i--;)1!==(n=o[i]).nodeType||N(n)?n.nodeType!==t||n.data||e.removeChild(n):(Te(n),C(n)&&!n.firstChild&&e.removeChild(n))},ye=e=>1===e.nodeType?"BR"===e.nodeName:u.test(e.data),Ee=(t,n)=>{let o,i=t.parentNode;for(;C(i);)i=i.parentNode;return(o=e.createTreeWalker(i,5,ye)).currentNode=t,!!o.nextNode()||n&&!o.previousNode()},Le=(e,t,n)=>{let o,i,r,s=e.querySelectorAll("BR"),a=[],l=s.length;for(o=0;o<l;++o)a[o]=Ee(s[o],n);for(;l--;)(r=(i=s[l]).parentNode)&&(a[l]?C(r)||I(r,t):i.remove())},be=(t,n,o,i,r,a)=>{let l,d,c=t.clipboardData,h=e.body,f=U(e,"div");f.append(n),l=f.innerHTML,i&&(l=i(l)),r?d=r(l):(Le(f,o,!0),f.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),h.append(f),d=(d=f.innerText||f.textContent).replace(" "," "),h.removeChild(f)),s&&(d=d.replace(/\r?\n/g,"\r\n")),a||d===l||c.setData("text/html",l),c.setData("text/plain",d),t.preventDefault()},ke=function(e){let n,o,i,r,s,a,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)e.preventDefault();else{if(this.saveUndoState(l),!d&&e.clipboardData){for(i=(n=Y(l,c))===(o=X(l,c))&&n||c,r=Q(l,c),(s=l.commonAncestorContainer).nodeType===t&&(s=s.parentNode);s&&s!==i;)(a=s.cloneNode(!1)).append(r),r=a,s=s.parentNode;be(e,r,c,this._config.willCutCopy,null,!1)}else setTimeout(()=>{try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);this.setSelection(l)}},Oe=function(e){((e,n,o,i,r,s)=>{let a,l,c,h,f,u;if(!d&&e.clipboardData){for(c=(a=Y(n,o))===(l=X(n,o))&&a||o,n=n.cloneRange(),$(n),V(n,c,c,o),h=n.cloneContents(),(f=n.commonAncestorContainer).nodeType===t&&(f=f.parentNode);f&&f!==c;)(u=f.cloneNode(!1)).append(h),h=u,f=f.parentNode;be(e,h,o,i,r,s)}})(e,this.getSelection(),this._root,this._config.willCutCopy,null,!1)};function xe(e){this.isShiftDown=e.shiftKey}let Ae=function(t){let n,o,i,r,s,a=t.clipboardData,c=a&&a.items,h=this.isShiftDown,f=!1,u=!1,g=!1,m=null,S=null,N=this;if(c){for(n=c.length;n--;)"text/html"===(i=(o=c[n]).type)?S=o:"text/plain"===i||"text/uri-list"===i?m=o:"text/rtf"===i?u=!0:/^image\/.*/.test(i)&&(g=!0);if(g&&(!u||!S))return t.preventDefault(),this.fireEvent("dragover",{dataTransfer:a,preventDefault:()=>f=!0}),void(f&&this.fireEvent("drop",{dataTransfer:a}));if(!d)return t.preventDefault(),void(!S||h&&m?m&&m.getAsString(e=>N.insertPlainText(e,!0)):S.getAsString(e=>N.insertHTML(e,!0)))}if(r=a&&a.types,!d&&r&&(p(r,"text/html")>-1||!l&&p(r,"text/plain")>-1&&p(r,"text/rtf")<0))return t.preventDefault(),void(!h&&(s=a.getData("text/html"))?this.insertHTML(s,!0):((s=a.getData("text/plain"))||(s=a.getData("text/uri-list")))&&this.insertPlainText(s,!0));let _=e.body,C=this.getSelection(),v=C.startContainer,T=C.startOffset,y=C.endContainer,E=C.endOffset,L=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});_.append(L),C.selectNodeContents(L),this.setSelection(C),setTimeout(()=>{try{let e,t,n="",o=L;for(;L=o;)o=L.nextSibling,L.remove(),(e=L.firstChild)&&e===L.lastChild&&"DIV"===e.nodeName&&(L=e),n+=L.innerHTML;t=N.createRange(v,T,y,E),N.setSelection(t),n&&N.insertHTML(n,!0)}catch(e){N.didError(e)}},0)},Re=function(e){let t=e.dataTransfer.types,n=t.length,o=!1,i=!1;for(;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()};function Be(e,t,n){let o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?Be(e[o],i,n):i);return e}function De(t,o){let i;t.nodeType===n&&(t=t.body),this._root=t,this._events={},this._isFocused=!1,this._lastRange=null,this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1;const r=()=>{if(t.contains(e.activeElement)){let e=this;e._isFocused&&!e._willUpdatePath&&(e._willUpdatePath=!0,setTimeout(function(){e._willUpdatePath=!1,e._updatePath(e.getSelection())},0))}else this.removeEventListener("selectionchange",r)};this.addEventListener("selectstart",()=>this.addEventListener("selectionchange",r)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,(i=new MutationObserver(()=>this._docWasChanged())).observe(t,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=i,this._restoreSelection=!1,this.addEventListener("blur",()=>this._restoreSelection=!0).addEventListener("pointerdown mousedown touchstart",()=>this._restoreSelection=!1).addEventListener("focus",()=>this._restoreSelection&&this.setSelection(this._lastRange)).addEventListener("cut",ke).addEventListener("copy",Oe).addEventListener("keydown keyup",xe).addEventListener("paste",Ae).addEventListener("drop",Re).addEventListener("keydown",re).addEventListener("pointerup keyup mouseup touchend",()=>this.getSelection()),this._keyHandlers=Object.create(he),this.setConfig(o),t.setAttribute("contenteditable","true"),t.setAttribute("data-gramm","false");try{e.execCommand("enableObjectResizing",!1,"false"),e.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}t.__squire__=this,this.setHTML("")}let Ue=De.prototype,Pe=t=>{let n=t?o.DOMPurify.sanitize(t,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return n?e.importNode(n,!0):e.createDocumentFragment()};Ue.setConfig=function(e){return(e=Be({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},classNames:{colour:"colour",fontFamily:"font",fontSize:"size",highlight:"highlight"},leafNodeNames:S,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:o.DOMPurify&&o.DOMPurify.isSupported?Pe:null,willCutCopy:null,addLinks:!0},e,!0)).blockTag=e.blockTag.toUpperCase(),this._config=e,this},Ue.createElement=function(t,n,o){return U(e,t,n,o)},Ue.createDefaultBlock=function(e){let t=this._config;return P(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},Ue.didError=(e=>console.error(e)),Ue.getRoot=function(){return this._root},Ue.modifyDocument=function(e){let t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};let Ie={pathChange:1,select:1,input:1,undoStateChange:1};Ue.fireEvent=function(t,n){let o,i,r,s=this._events[t];if(/^(?:focus|blur)/.test(t))if(o=this._root===e.activeElement,"focus"===t){if(!o||this._isFocused)return this;this._isFocused=!0}else{if(o||!this._isFocused)return this;this._isFocused=!1}if(s)for(n||(n={}),n.type!==t&&(n.type=t),i=(s=s.slice()).length;i--;){r=s[i];try{r.handleEvent?r.handleEvent(n):r.call(this,n)}catch(e){e.details="Squire: fireEvent error. Event type: "+t,this.didError(e)}}return this},Ue.destroy=function(){let e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},Ue.handleEvent=function(e){this.fireEvent(e.type,e)},Ue.addEventListener=function(t,n){return t.split(/\s+/).forEach(t=>{let o=this._events[t],i=this._root;if(!n)return this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+t}),this;o||(o=this._events[t]=[],Ie[t]||("selectionchange"===t&&(i=e),i.addEventListener(t,this,!0))),o.push(n)}),this},Ue.removeEventListener=function(t,n){let o,i=this._events[t],r=this._root;if(i){if(n)for(o=i.length;o--;)i[o]===n&&i.splice(o,1);else i.length=0;i.length||(delete this._events[t],Ie[t]||("selectionchange"===t&&(r=e),r.removeEventListener(t,this,!0)))}return this},Ue.createRange=function(t,n,i,r){if(t instanceof o.Range)return t.cloneRange();let s=e.createRange();return s.setStart(t,n),i?s.setEnd(i,r):s.setEnd(t,n),s},Ue.getCursorPosition=function(t){if(!t&&!(t=this.getSelection())||!t.getBoundingClientRect)return null;let n,o,i=t.getBoundingClientRect();return i&&!i.top&&(this._ignoreChange=!0,(n=e.createElement("SPAN")).textContent="​",K(t,n),i=n.getBoundingClientRect(),(o=n.parentNode).removeChild(n),M(o,t)),i},Ue.setSelection=function(e){if(e)if(this._lastRange=e,this._isFocused){a&&o.focus();let t=o.getSelection();t&&t.setBaseAndExtent?t.setBaseAndExtent(e.startContainer,e.startOffset,e.endContainer,e.endOffset):t&&(t.removeAllRanges(),t.addRange(e))}else this._restoreSelection=!0;return this},Ue.getSelection=function(){let t,n,i,r,s=o.getSelection(),a=this._root;return this._isFocused&&s&&s.rangeCount&&(n=(t=s.getRangeAt(0).cloneRange()).startContainer,i=t.endContainer,n&&N(n)&&t.setStartBefore(n),i&&N(i)&&t.setEndBefore(i)),t&&a.contains(t.commonAncestorContainer)?this._lastRange=t:(r=(t=this._lastRange).commonAncestorContainer,e.contains(r)||(t=null)),t||this.createRange(a.firstChild,0)},Ue.getSelectionClosest=function(e){let t=this.getSelection();return t&&x(t.commonAncestorContainer,this._root,e)},Ue.selectionContains=function(e){let t=this.getSelection(),n=t&&t.commonAncestorContainer;return!(!n||t.collapsed)&&!(!(n=n.querySelector?n:n.parentElement)||!n.querySelector(e))},Ue.getSelectedText=function(){let n=this.getSelection();if(!n||n.collapsed)return"";let o,i=e.createTreeWalker(n.commonAncestorContainer,5,e=>Z(n,e,!0)),r=n.startContainer,s=n.endContainer,a=i.currentNode=r,l="",d=!1;for(i.filter(a)||(a=i.nextNode());a;)a.nodeType===t?(o=a.data)&&/\S/.test(o)&&(a===s&&(o=o.slice(0,n.endOffset)),a===r&&(o=o.slice(n.startOffset)),l+=o,d=!0):("BR"===a.nodeName||d&&!C(a))&&(l+="\n",d=!1),a=i.nextNode();return l},Ue.getPath=function(){return this._path};let Fe=(t,n)=>{let o,i,r,s=e.createTreeWalker(t,4);for(;i=s.nextNode();)for(;(r=i.data.indexOf("​"))>-1&&(!n||i.parentNode!==n);){if(1===i.length){do{(o=i.parentNode).removeChild(i),i=o,s.currentNode=o}while(C(i)&&!B(i));break}i.deleteData(r,1)}};Ue._didAddZWS=function(){this._hasZWS=!0},Ue._removeZWS=function(){this._hasZWS&&(Fe(this._root),this._hasZWS=!1)},Ue._updatePath=function(e,t){if(!e)return;let n,o=e.startContainer,i=e.endContainer;(t||o!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=i,n=o&&i?o===i?R(i,this._root,this._config):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})},Ue.focus=function(){return this._root.focus({preventScroll:!0}),this},Ue.blur=function(){return this._root.blur(),this};const We=e=>[e.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),e.createElement("INPUT",{id:"squire-selection-end",type:"hidden"})];Ue._saveRangeToBookmark=function(e){let t,[n,o]=We(this);K(e,n),e.collapse(!1),K(e,o),2&n.compareDocumentPosition(o)&&(n.id="squire-selection-end",o.id="squire-selection-start",t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},Ue._getRangeAndRemoveBookmark=function(n){let o=this._root,i=o.querySelector("#squire-selection-start"),r=o.querySelector("#squire-selection-end");if(i&&r){let o=i.parentNode,s=r.parentNode,a=p(o.childNodes,i),l=p(s.childNodes,r);o===s&&--l,i.remove(),r.remove(),n||(n=e.createRange()),n.setStart(o,a),n.setEnd(s,l),M(o,n),o!==s&&M(s,n),n.collapsed&&(o=n.startContainer).nodeType===t&&((s=o.childNodes[n.startOffset])&&s.nodeType===t||(s=o.childNodes[n.startOffset-1]),s&&s.nodeType===t&&(n.setStart(s,0),n.collapse(!0)))}return n||null},Ue._keyUpDetectChange=(e=>{let t=e.keyCode;!e[f]&&!e.altKey&&(t<16||t>20)&&(t<33||t>45)&&this._docWasChanged()}),Ue._docWasChanged=function(){ie=new WeakMap,this._ignoreAllChanges||(this._ignoreChange?this._ignoreChange=!1:(this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")))},Ue._recordUndoState=function(e,t){if(!this._isInUndoState||t){let n,o=this._undoIndex,i=this._undoStack,r=this._config.undo,s=r.documentSizeThreshold,a=r.undoLimit;t||++o,o<this._undoStackLength&&(i.length=this._undoStackLength=o),e&&this._saveRangeToBookmark(e),n=this._getHTML(),s>-1&&2*n.length>s&&a>-1&&o>a&&(i.splice(0,o-a),o=a,this._undoStackLength=a),i[o]=n,this._undoIndex=o,++this._undoStackLength,this._isInUndoState=!0}},Ue.saveUndoState=function(e){return void 0===e&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},Ue.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),--this._undoIndex,this._setHTML(this._undoStack[this._undoIndex]);let e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},Ue.redo=function(){let e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){++this._undoIndex,this._setHTML(this._undoStack[this._undoIndex]);let n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input")}return this},Ue.hasFormat=function(n,o,i){if(n=n.toUpperCase(),o||(o={}),!i&&!(i=this.getSelection()))return!1;!i.collapsed&&i.startContainer.nodeType===t&&i.startOffset===i.startContainer.length&&i.startContainer.nextSibling&&i.setStartBefore(i.startContainer.nextSibling),!i.collapsed&&i.endContainer.nodeType===t&&0===i.endOffset&&i.endContainer.previousSibling&&i.setEndAfter(i.endContainer.previousSibling);let r,s,a=this._root,l=i.commonAncestorContainer;if(A(l,a,n,o))return!0;if(l.nodeType===t)return!1;r=e.createTreeWalker(l,4,e=>Z(i,e,!0));let d=!1;for(;s=r.nextNode();){if(!A(s,a,n,o))return!1;d=!0}return d},Ue.getFontInfo=function(e){let n,o,i,r={color:void 0,backgroundColor:void 0,family:void 0,size:void 0},s=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===t)for(n.nodeType===t&&(n=n.parentNode);s<4&&n;)(o=n.style)&&(!r.color&&(i=o.color)&&(r.color=i,++s),!r.backgroundColor&&(i=o.backgroundColor)&&(r.backgroundColor=i,++s),!r.family&&(i=o.fontFamily)&&(r.family=i,++s),!r.size&&(i=o.fontSize)&&(r.size=i,++s)),n=n.parentNode;return r},Ue._addFormat=function(n,o,i){let r,s,a,l,d,c,h,f,u,p=this._root;if(i.collapsed){for(r=P(this.createElement(n,o),p),K(i,r),i.setStart(r.firstChild,r.firstChild.length),i.collapse(!0),u=r;C(u);)u=u.parentNode;Fe(u,r)}else{if(s=e.createTreeWalker(i.commonAncestorContainer,5,e=>(e.nodeType===t||"BR"===e.nodeName||"IMG"===e.nodeName)&&Z(i,e,!0)),a=i.startContainer,d=i.startOffset,l=i.endContainer,c=i.endOffset,s.currentNode=a,s.filter(a)||(a=s.nextNode(),d=0),!a)return i;do{h=s.currentNode,(f=!A(h,p,n,o))&&(h===l&&h.length>c&&h.splitText(c),h===a&&d&&(h=h.splitText(d),l===a&&(l=h,c-=d),a=h,d=0),r=this.createElement(n,o),h.replaceWith(r),r.append(h))}while(s.nextNode());l.nodeType!==t&&(h.nodeType===t?(l=h,c=h.length):(l=h.parentNode,c=1)),i=this.createRange(a,d,l,c)}return i},Ue._removeFormat=function(n,o,i,r){let s;this._saveRangeToBookmark(i),i.collapsed&&(c?(s=e.createTextNode("​"),this._didAddZWS()):s=e.createTextNode(""),K(i,s));let a=i.commonAncestorContainer;for(;C(a);)a=a.parentNode;let l=i.startContainer,d=i.startOffset,h=i.endContainer,f=i.endOffset,u=[],p=function(e,n){if(Z(i,e,!1))return;let o,r,s=e.nodeType===t;if(Z(i,e,!0))if(s)e===h&&f!==e.length&&u.push([n,e.splitText(f)]),e===l&&d&&(e.splitText(d),u.push([n,e]));else for(o=e.firstChild;o;o=r)r=o.nextSibling,p(o,n);else"INPUT"===e.nodeName||s&&!e.data||u.push([n,e])},g=Array.prototype.filter.call(a.getElementsByTagName(n),function(e){return Z(i,e,!0)&&O(e,n,o)});return r||g.forEach(function(e){p(e,e)}),u.forEach(function(e){let t=e[0].cloneNode(!1),n=e[1];n.replaceWith(t),t.append(n)}),g.forEach(function(e){e.replaceWith(D(e))}),this._getRangeAndRemoveBookmark(i),s&&i.collapse(!1),M(a,i),i},Ue.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),this):this};let Me={DT:"DD",DD:"DT",LI:"LI",PRE:"PRE"},we=(t,n,o,i)=>{let r=Me[n.nodeName],s=null,a=F(o,i,n.parentNode,t._root),l=t._config;return r||(r=l.blockTag,s=l.blockAttributes),O(a,r,s)||(n=U(e,r,s),a.dir&&(n.dir=a.dir),a.replaceWith(n),n.append(D(a)),a=n),a};Ue.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);let o=this._root,i=Y(n,o),r=X(n,o);if(i&&r)do{if(e(i)||i===r)break}while(i=L(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0)),this},Ue.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);let n,o=this._root;return ne(t,o),V(t,o,o,o),n=G(t,o,o),K(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&H(t.endContainer.childNodes[t.endOffset],o),H(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),this};let He=function(e){var t=e.querySelectorAll("blockquote");return Array.prototype.filter.call(t,t=>!x(t.parentNode,e,"BLOCKQUOTE")).forEach(e=>e.replaceWith(D(e))),e},ze=(e,t,n)=>{let o,i,r,s,a=y(t,e._root),l=e._config.tagAttributes,d=l[n.toLowerCase()],c=l.li;for(;o=a.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,a.currentNode=o.lastChild),"LI"!==o.nodeName?(s=e.createElement("LI",c),o.dir&&(s.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.append(s),o.remove()):o.replaceWith(e.createElement(n,d,[s])),s.append(D(o)),a.currentNode=s):(i=(o=o.parentNode).nodeName)!==n&&/^[OU]L$/.test(i)&&o.replaceWith(e.createElement(n,d,[D(o)]))},qe=(e,t)=>{let n=e.commonAncestorContainer,o=e.startContainer,i=e.endContainer;for(;n&&n!==t&&!/^[OU]L$/.test(n.nodeName);)n=n.parentNode;if(!n||n===t)return null;for(o===n&&(o=o.childNodes[e.startOffset]),i===n&&(i=i.childNodes[e.endOffset]);o&&o.parentNode!==n;)o=o.parentNode;for(;i&&i.parentNode!==n;)i=i.parentNode;return[n,o,i]};Ue.increaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();let t=this._root,n=qe(e,t);if(!n)return this.focus();let o=n[0],i=n[1],r=n[2];if(!i||i===o.firstChild)return this.focus();this._recordUndoState(e,this._isInUndoState);let s,a,l=o.nodeName,d=i.previousSibling;d.nodeName!==l&&(s=this._config.tagAttributes[l.toLowerCase()],d=this.createElement(l,s),i.before(d));do{a=i===r?null:i.nextSibling,d.append(i)}while(i=a);return(a=d.nextSibling)&&H(a,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},Ue.decreaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();let t=this._root,n=qe(e,t);if(!n)return this.focus();let o,i,r,s,a=n[0],l=n[1],d=n[2];if(l||(l=a.firstChild),d||(d=a.lastChild),this._recordUndoState(e,this._isInUndoState),l){if(o=a.parentNode,r=d.nextSibling?F(a,d.nextSibling,o,t):a.nextSibling,o!==t&&"LI"===o.nodeName){for(o=o.parentNode;r;)i=r.nextSibling,d.append(r),r=i;r=a.parentNode.nextSibling}s=!/^[OU]L$/.test(o.nodeName);do{i=l===d?null:l.nextSibling,a.removeChild(l),s&&"LI"===l.nodeName&&(l=this.createDefaultBlock([D(l)])),o.insertBefore(l,r)}while(l=i)}return a.firstChild||a.remove(),r&&H(r,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},Ue._ensureBottomLine=function(){let e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&v(t)||e.append(this.createDefaultBlock())},Ue.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},Ue._getHTML=function(){return this._root.innerHTML},Ue._setHTML=function(e){let t=this._root,n=t;n.innerHTML=e;do{P(n,t)}while(n=L(n,t));this._ignoreChange=!0},Ue.getHTML=function(e){let t,n;return e&&(n=this.getSelection())&&this._saveRangeToBookmark(n),t=this._getHTML().replace(/\u200B/g,""),n&&this._getRangeAndRemoveBookmark(n),t},Ue.setHTML=function(t){let n,o,i,r=this._config,s=r.isSetHTMLSanitized?r.sanitizeToDOMFragment:null,a=this._root;"function"==typeof s?o=s(t,!1,this):((n=this.createElement("DIV")).innerHTML=t,(o=e.createDocumentFragment()).append(D(n))),ve(o,r),Le(o,a,!1),I(o,a);let l=o;for(;l=L(l,a);)P(l,a);for(this._ignoreChange=!0;i=a.lastChild;)a.removeChild(i);a.append(o),P(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;let d=this._getRangeAndRemoveBookmark()||this.createRange(a.firstChild,0);return this.saveUndoState(d),this._lastRange=d,this._restoreSelection=!0,this._updatePath(d,!0),this},Ue.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),C(e))K(t,e),t.setStartAfter(e);else{let n,o,i=this._root,r=Y(t,i)||i;for(;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(n=r.parentNode,o=F(n,r.nextSibling,i,i)),o?o.before(e):(i.append(e),o=this.createDefaultBlock(),i.append(o)),t.setStart(o,0),t.setEnd(o,0),$(t)}return this.focus(),this.setSelection(t),this._updatePath(t),this},Ue.insertImage=function(e,t){let n=this.createElement("IMG",Be({src:e},t,!0));return this.insertElement(n),n},Ue.linkRegExp=/\b(?:((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9][a-z0-9.-]*[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:[^\s?&`!()[\]{};:'".,<>«»“”‘’]|\([^\s()<>]+\)))|([\w\-.%+]+@(?:[\w-]+\.)+[a-z]{2,}\b(?:[?][^&?\s]+=[^\s?&`!()[\]{};:'".,<>«»“”‘’]+(?:&[^&?\s]+=[^\s?&`!()[\]{};:'".,<>«»“”‘’]+)*)?))/i;let Ke=(t,n,o)=>{let i,r,s,a,l,d,c=e.createTreeWalker(t,4,e=>!x(e,n,"A")),h=o.linkRegExp,f=o._config.tagAttributes.a;if(h)for(;i=c.nextNode();)for(r=i.data;s=h.exec(r);)l=(a=s.index)+s[0].length,a&&(d=e.createTextNode(r.slice(0,a)),i.before(d)),(d=o.createElement("A",Be({href:s[1]?/^(?:ht|f)tps?:/i.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[0]},f,!1))).textContent=r.slice(a,l),i.before(d),i.data=r=r.slice(l)};Ue.insertHTML=function(t,n){let o,i,r,s,a,l,d,c=this._config,h=c.isInsertedHTMLSanitized?c.sanitizeToDOMFragment:null,f=this.getSelection();"function"==typeof h?s=h(t,n,this):(n&&(o=t.indexOf("\x3c!--StartFragment--\x3e"),i=t.lastIndexOf("\x3c!--EndFragment--\x3e"),o>-1&&i>-1&&(t=t.slice(o+20,i))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(t)&&(t="<TR>"+t+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(t)&&(t="<TABLE>"+t+"</TABLE>"),(r=this.createElement("DIV")).innerHTML=t,(s=e.createDocumentFragment()).append(D(r))),this.saveUndoState(f);try{for(a=this._root,l=s,d={fragment:s,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},Ke(s,s,this),ve(s,c),Le(s,a,!1),Te(s),s.normalize();l=L(l,s);)P(l,a);n&&this.fireEvent("willPaste",d),d.defaultPrevented||(((t,n,o)=>{let i,r,s,a,l,d,c,h,f,u,g,m=n.firstChild&&C(n.firstChild);for(I(n,o),i=n;i=L(i,o);)P(i,o);if(t.collapsed||Q(t,o),$(t),t.collapse(!1),a=x(t.endContainer,o,"BLOCKQUOTE")||o,r=Y(t,o),h=L(n,n),c=!m&&!!r&&b(r),r&&h&&!c&&!x(h,n,"PRE,TABLE")){if(V(t,r,r,o),t.collapse(!0),l=t.endContainer,d=t.endOffset,Le(r,o,!1),C(l)&&(l=(f=F(l,d,E(l,o),o)).parentNode,d=p(l.childNodes,f)),d!==B(l))for(s=e.createDocumentFragment();i=l.childNodes[d];)s.append(i);w(l,h,t,o),d=p(l.parentNode.childNodes,l)+1,l=l.parentNode,t.setEnd(l,d)}B(n)&&(c&&(t.setEndBefore(r),t.collapse(!1),r.remove()),V(t,a,a,o),u=(f=F(t.endContainer,t.endOffset,a,o))?f.previousSibling:a.lastChild,f.before(n),f?t.setEndBefore(f):t.setEnd(a,B(a)),r=X(t,o),$(t),l=t.endContainer,d=t.endOffset,f&&T(f)&&H(f,o),(f=u&&u.nextSibling)&&T(f)&&H(f,o),t.setEnd(l,d)),s&&(g=t.cloneRange(),w(r,s,g,o),t.setEnd(g.endContainer,g.endOffset)),$(t)})(f,d.fragment,a),f.collapse(!1),j(f,0,a),this._ensureBottomLine()),this.setSelection(f),this._updatePath(f,!0),n&&this.focus()}catch(e){this.didError(e)}return this};let Ge=e=>e.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;").replace('"',"&quot;");Ue.insertPlainText=function(n,o){let i=this.getSelection();if(i.collapsed&&x(i.startContainer,this._root,"PRE")){let r,s,a=i.startContainer,l=i.startOffset;return a&&a.nodeType===t||(r=e.createTextNode(""),a.childNodes[l].before(r),a=r,l=0),s={text:n,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},o&&this.fireEvent("willPaste",s),s.defaultPrevented||(n=s.text,a.insertData(l,n),i.setStart(a,l+n.length),i.collapse(!0)),this.setSelection(i),this}let r,s,a,l,d=n.split("\n"),c=this._config,h=c.blockTag,f=c.blockAttributes,u="</"+h+">",p="<"+h;for(r in f)p+=" "+r+'="'+Ge(f[r])+'"';for(p+=">",s=0,a=d.length;s<a;++s)l=d[s],l=Ge(l).replace(/ (?= )/g,"&nbsp;"),s&&(l=p+(l||"<BR>")+u),d[s]=l;return this.insertHTML(d.join(""),o)};let Qe=(e,t,n)=>(function(){return this[e](t,n),this.focus()});Ue.addStyles=function(t){if(t){let n=e.documentElement.firstChild,o=this.createElement("STYLE",{type:"text/css"});o.append(e.createTextNode(t)),n.append(o)}return this},Ue.bold=Qe("changeFormat",{tag:"B"}),Ue.italic=Qe("changeFormat",{tag:"I"}),Ue.underline=Qe("changeFormat",{tag:"U"}),Ue.strikethrough=Qe("changeFormat",{tag:"S"}),Ue.subscript=Qe("changeFormat",{tag:"SUB"},{tag:"SUP"}),Ue.superscript=Qe("changeFormat",{tag:"SUP"},{tag:"SUB"}),Ue.removeBold=Qe("changeFormat",null,{tag:"B"}),Ue.removeItalic=Qe("changeFormat",null,{tag:"I"}),Ue.removeUnderline=Qe("changeFormat",null,{tag:"U"}),Ue.removeStrikethrough=Qe("changeFormat",null,{tag:"S"}),Ue.removeSubscript=Qe("changeFormat",null,{tag:"SUB"}),Ue.removeSuperscript=Qe("changeFormat",null,{tag:"SUP"}),Ue.makeLink=function(t,n){let o=this.getSelection();if(o.collapsed){let n=t.indexOf(":")+1;if(n)for(;"/"===t[n];)++n;K(o,e.createTextNode(t.slice(n)))}return n=Be(Be({href:t},n,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:n},{tag:"A"},o),this.focus()},Ue.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},Ue.setFontFace=function(e){let t=this._config.classNames.fontFamily;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},Ue.setFontSize=function(e){let t=this._config.classNames.fontSize;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},Ue.setTextColour=function(e){let t=this._config.classNames.colour;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"color:"+e}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},Ue.setHighlightColour=function(e){let t=this._config.classNames.highlight;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{class:t}}),this.focus()},Ue.setTextAlignment=function(e){return this.forEachBlock(function(t){let n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},Ue.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()};let Ze=function(t){let n,o=this._root,i=e.createDocumentFragment(),r=y(t,o);for(;n=r.nextNode();){let t,o,r=n.querySelectorAll("BR"),s=[],a=r.length;for(t=0;t<a;++t)s[t]=Ee(r[t],!1);for(;a--;)o=r[a],s[a]?o.replaceWith(e.createTextNode("\n")):o.remove();for(a=(r=n.querySelectorAll("CODE")).length;a--;)r[a].remove();i.childNodes.length&&i.append(e.createTextNode("\n")),i.append(D(n))}for(r=e.createTreeWalker(i,4);n=r.nextNode();)n.data=n.data.replace(" "," ");return i.normalize(),P(this.createElement("PRE",this._config.tagAttributes.pre,[i]),o)},$e=function(t){let n,o,i,r,s,a,l=this._root,d=t.querySelectorAll("PRE"),c=d.length;for(;c--;){for(n=d[c],o=e.createTreeWalker(n,4);i=o.nextNode();){for(r=(r=i.data).replace(/ (?= )/g," "),s=e.createDocumentFragment();(a=r.indexOf("\n"))>-1;)s.append(e.createTextNode(r.slice(0,a))),s.append(e.createElement("BR")),r=r.slice(a+1);i.before(s),i.data=r}I(n,l),n.replaceWith(D(n))}return t};Ue.code=function(){let e=this.getSelection();return e.collapsed||T(e.commonAncestorContainer)?this.modifyBlocks(Ze,e):this.changeFormat({tag:"CODE",attributes:this._config.tagAttributes.code},null,e),this.focus()},Ue.removeCode=function(){let e=this.getSelection(),t=e.commonAncestorContainer;return x(t,this._root,"PRE")?this.modifyBlocks($e,e):this.changeFormat(null,{tag:"CODE"},e),this.focus()},Ue.toggleCode=function(){return this.hasFormat("PRE")||this.hasFormat("CODE")?this.removeCode():this.code(),this},Ue.removeAllFormatting=function(n){if(!n&&!(n=this.getSelection())||n.collapsed)return this;let o=this._root,i=n.commonAncestorContainer;for(;i&&!v(i);)i=i.parentNode;if(i||(ne(n,o),i=o),i.nodeType===t)return this;this.saveUndoState(n),V(n,i,i,o);let r,s,a=n.startContainer,l=n.startOffset,d=n.endContainer,c=n.endOffset,h=e.createDocumentFragment(),f=e.createDocumentFragment(),u=F(d,c,i,o),g=F(a,l,i,o);for(;g!==u;)r=g.nextSibling,h.append(g),g=r;return function n(o,i,r){let s,a;for(s=i.firstChild;s;s=a){if(a=s.nextSibling,C(s)){if(s.nodeType===t||"BR"===s.nodeName||"IMG"===s.nodeName){r.append(s);continue}}else if(v(s)){r.append(o.createDefaultBlock([n(o,s,e.createDocumentFragment())]));continue}n(o,s,r)}return r}(this,h,f),f.normalize(),g=f.firstChild,r=f.lastChild,s=i.childNodes,g?(u.before(f),l=p(s,g),c=p(s,r)+1):c=l=p(s,u),n.setStart(i,l),n.setEnd(i,c),M(i,n),$(n),this.setSelection(n),this._updatePath(n,!0),this.focus()},Ue.increaseQuoteLevel=Qe("modifyBlocks",function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])}),Ue.decreaseQuoteLevel=Qe("modifyBlocks",He),Ue.changeIndentationLevel=function(e){let t=this.getSelectionClosest("UL,OL,BLOCKQUOTE");if(t||"increase"===e){this[e+(t&&"BLOCKQUOTE"!==t.nodeName?"List":"Quote")+"Level"]()}},Ue.makeUnorderedList=Qe("modifyBlocks",function(e){return ze(this,e,"UL"),e}),Ue.makeOrderedList=Qe("modifyBlocks",function(e){return ze(this,e,"OL"),e}),Ue.removeList=Qe("modifyBlocks",function(e){let t,n,o,i,r,s=e.querySelectorAll("UL, OL"),a=e.querySelectorAll("LI"),l=this._root;for(t=0,n=s.length;t<n;++t)o=s[t],i=D(o),I(i,l),o.replaceWith(i);for(t=0,n=a.length;t<n;++t)r=a[t],v(r)?r.replaceWith(this.createDefaultBlock([D(r)])):(I(r,l),r.replaceWith(D(r)));return e}),o.Squire=De})(document);
